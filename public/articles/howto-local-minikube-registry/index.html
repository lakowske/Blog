<html>
  <head>
    <title>How-to run Kubernetes, Registry locally with ingress</title>
    <link rel="stylesheet" type="text/css"
          href="/static/style/style.css">
    <link rel="stylesheet" type="text/css"
          href="/static/bundles/triangles/style.css">
  </head>

  <body>
    <h2>Expose Registry and Dashboard with Helm on Minikube</h2>
    <h3>Posted by: <a href="http://sethlakowske.com">Seth Lakowske</a></h3>
    <h4>Published: <time pubdate="pubdate">2017-12-08</time></h4>

    <p>
      This guide will walk you through the steps to setting up an
      environment to run Kubernetes (K8S), Docker Registry and Nginx
      Ingress on your laptop or workstation.
      You'll need to install Docker, Minikube, Helm and
      Kubernetes client (kubectl).
    </p>
    <H2>Requirements</H2>
    <ul>
      <li>
        <b>Docker:</b>
        Install <a href="https://www.docker.com/products/docker-toolbox">Docker Toolbox</a>.
      </li>
      <li>
        <b>Kubectl:</b>
        Follow the instructions at <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">Installing
        and Setting up kubectl</a> to install kubectl.  kubectl is the general
        purpose CLI client for inspecting and manipulating a kubernetes cluster.
      </li>
      <li>
	<b>Minikube:</b>
	Install <a href="https://kubernetes.io/docs/tasks/tools/install-minikube"/>Minikube</a>
      </li>
      <li>
	<b>Helm:</b>
	Install <a href="https://github.com/kubernetes/helm/blob/master/docs/install.md"/>Helm</a>
      </li>
      
      
    </ul>

    <H2>Run Kubernetes using Minikube</H2>

    Once you have Docker Toolbox installed, you can use Docker
    and Minikube together with Minikube's built-in docker engine.
    <br><br>
    Start Minikube with a generous helping of resources if you have big
    loads: 4 cpus, 6 GB of RAM and 100 GB Storage.
    
    <pre><code class="language-bash">minikube start --cpus 4 --disk-size 100g --memory 6000 --insecure-registry registry.minikube.st81ess.com:80</code></pre>

    Requests to registry.minikube.st81ess.com will resolve to your
    local minikube ingress address, 192.168.99.100, and
    nginx ingress controller will route the request to a backing
    registry service using the hostname provided.
    <br><br>
    *.minikube.st81ess.com has been setup to resolves to
    192.168.99.100. *.minikube.st81ess.com is a flexible wildcard DNS
    useful in a typical Minikube environments to route into http/https
    Ingress resources within K8S.  If you had your own domain, you could create
    *.minikube.mydomain.com to do the same.
    
    <H3>Run a local private registry</H3>
    
    Start a private local registry that Kubernetes always restarts if the container dies.
    <pre><code class="language-bash">minikube addons enable registry</code></pre>

    Turn on the ingress controller
    <pre><code class="language-bash">minikube addons enable ingress</code></pre>

    Add a chart repo.
    <pre><code class="language-bash">helm repo add lakowske https://lakowske.github.io/charts
#After adding the repo, update your index.	
helm repo update
    </code></pre>

    If you haven't already done so, init helm and wait for tiller
    <pre><code class="language-bash">helm init ; kubectl rollout status -w deployment/tiller-deploy --namespace=kube-system</code></pre>
    
    Install the dashboard ingress chart to expose the dashboard on <a href="http://dashboard.minikube.st81ess.com">http://dashboard.minikube.st81ess.com</a>
    <pre><code class="language-bash">helm install --namespace kube-system lakowske/minikube-dashboard-ingress</code></pre>

    Install a registry ingress chart to expose the registry on <a href="http://registry.minikube.st81ess.com">http://registry.minikube.st81ess.com</a>
    <pre><code class="language-bash">helm install --namespace kube-system lakowske/minikube-dashboard-ingress --set ingress.host=registry.minikube.st81ess.com --set service.name=registry</code></pre>

    Edit the nginx ingress config map and set nginx-load-balancer-conf config map proxy-body-size to 0 in the data section.  This way you'll be able to upload large layers to the registry.
    <pre><code class="language-bash">kubectl edit configmap --namespace kube-system nginx-load-balancer-conf</code></pre>
    
    To import the Docker environment into your current shell.

    <pre><code class="language-bash">eval $(minikube docker-env)</code></pre>
    
    Build an image and tag it.
    <pre><code class="language-bash">git clone https://bitbucket.org/seth_lakowske/hello-node.git
cd hello-node
docker build -t hello-node .
docker tag hello-node registry.minikube.st81ess.com:80/hello-node</code></pre>
    Push the image to your local registry.
    <pre><code class="language-bash">docker push registry.minikube.st81ess.com:80/hello-node</code></pre>
    Now run a deployment in Kubernetes using the image located on your
    local registry.
    <pre><code class="language-bash">kubectl run hello-node --image=registry.minikube.st81ess.com:80/hello-node --port=8888</code></pre>
    
    <H3 style="color: orange">Conclusion</H3>
    <p>
    You should now have a deployment of your image, in my case hello-node, running using your
    private local registry, Kubernetes and Docker.  You can verify by
    running <span><pre><code class="language-bash">kubectl get deployments</code></pre></span>
    or <a href="http://dashboard.minikube.st81ess.com">http://dashboard.minikube.st81ess.com</a> and viewing your deployments.
    </p>
    
    <!-- <script src="/static/bundles/triangles/bundle.js"></script> -->
    <table id="related"></table>


  <!-- Google analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-30272910-1', 'auto');
    ga('send', 'pageview');
  </script>
    
  </body>
</html>
